<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Page du Groupe</title>
  <link rel="stylesheet" href="style.css">
  <style>
    #content.hidden, #login.hidden {
      display: none;
    }
    .warning-text {
        color: #e43f5a;
        font-weight: bold;
        background-color: rgba(228, 63, 90, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e43f5a;
    }
    #spirits-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    .spirit-card {
        flex-basis: 250px; /* Set a base width for flex items */
    }
    .spirit-card {
      background-color: #1a1a2e;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #1f4068;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .spirit-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 15px rgba(228, 63, 90, 0.5);
    }
    .spirit-card h3 {
        margin-top: 0;
        color: #1f8a70;
    }
    .spirit-form {
        margin-top: 15px;
    }
    .enigma-alert {
        margin-top: 10px;
        color: #e43f5a;
        font-weight: bold;
        animation: blink-animation 1.5s infinite;
    }
    @keyframes blink-animation {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
  </style>
</head>
<body>
  <div id="login" class="container">
    <h1 id="groupName"></h1>
    <p>Veuillez entrer le mot de passe pour continuer.</p>
    <form id="login-form">
      <input type="password" id="password" placeholder="Mot de passe du groupe">
      <button id="submitPassword" type="button">Entrer</button>
    </form>
    <p id="error" class="error-message"></p>
  </div>

  <div id="content" class="container hidden">
    <h2>Bienvenue, <span id="welcomeGroupName"></span>!</h2>
    <p>Les esprits attendent. Entrez leurs codes pour les rencontrer. Mettez du son, ils vous parleront.</p>
    <p class="warning-text">Attention, chaque relecture audio vous coûtera des points!</p>

    <div id="spirits-container">
      <!-- Spirit cards will be dynamically generated or can be hardcoded -->
      <div class="spirit-card" id="cardA">
        <h3>Esprit A</h3>
        <form class="spirit-form" id="formA">
          <input type="text" id="codeA" placeholder="Code de l'esprit">
          <button type="submit">Rencontrer</button>
          <span id="enigmaA" class="enigma-alert hidden">Énigme reçue !</span>
        </form>
      </div>
      <div class="spirit-card" id="cardB">
        <h3>Esprit B</h3>
        <form class="spirit-form" id="formB">
          <input type="text" id="codeB" placeholder="Code de l'esprit">
          <button type="submit">Rencontrer</button>
          <span id="enigmaB" class="enigma-alert hidden">Énigme reçue !</span>
        </form>
      </div>
      <div class="spirit-card" id="cardC">
        <h3>Esprit C</h3>
        <form class="spirit-form" id="formC">
          <input type="text" id="codeC" placeholder="Code de l'esprit">
          <button type="submit">Rencontrer</button>
          <span id="enigmaC" class="enigma-alert hidden">Énigme reçue !</span>
        </form>
      </div>
      <div class="spirit-card" id="cardD">
        <h3>Esprit D</h3>
        <form class="spirit-form" id="formD">
          <input type="text" id="codeD" placeholder="Code de l'esprit">
          <button type="submit">Rencontrer</button>
          <span id="enigmaD" class="enigma-alert hidden">Énigme reçue !</span>
        </form>
      </div>
    </div>
    <p id="spiritError" class="error-message"></p>
    <a href="joueur.html" style="margin-top: 30px; display: inline-block;">Changer de groupe</a>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const groupName = params.get('name');

      if (!groupName) {
        document.body.innerHTML = '<div class="container"><h1>Aucun groupe spécifié.</h1><a href="joueur.html">Retour</a></div>';
        return;
      }

      // Setup page elements
      document.getElementById('groupName').textContent = `Groupe: ${groupName}`;
      document.getElementById('welcomeGroupName').textContent = groupName;
      const loginContainer = document.getElementById('login');
      const contentContainer = document.getElementById('content');
      const errorP = document.getElementById('error');
      const spiritErrorP = document.getElementById('spiritError');

      // --- Data Fetching ---
      async function getGroupsData() {
        try {
            const apiUrl = 'https://api.github.com/repos/Zhaal/un-loup-garou-a-eu/contents/scores-loup-garou.json';
            const response = await fetch(`${apiUrl}?ref=main`, {
                headers: { 'Accept': 'application/vnd.github.v3.raw' },
                cache: 'no-store'
            });
            if (!response.ok) throw new Error('Could not fetch group data from GitHub.');
            return await response.json();
        } catch (err) {
            errorP.textContent = `Erreur critique: ${err.message}`;
            return null;
        }
      }

      // --- UI Update Functions ---
      function updateUIAfterEncounter(spiritId, answer) {
        const input = document.getElementById(`code${spiritId}`);
        const button = document.getElementById(`form${spiritId}`).querySelector('button');
        const card = document.getElementById(`card${spiritId}`);

        input.value = `Rencontré (${answer})`;
        input.disabled = true;
        button.disabled = true;
        button.textContent = 'Terminé';
        card.style.borderColor = '#1f8a70'; // Teal border for completed
      }

      const spiritCodes = { A: '117b', B: '222t', C: '365p', D: '412v' };

      function showContent() {
        loginContainer.classList.add('hidden');
        contentContainer.classList.remove('hidden');
        checkEnigmas();
      }

      async function checkEnigmas() {
          const allGroups = await getGroupsData();
          if (!allGroups) return;
          const groupData = allGroups[groupName];

          if (groupData?.data?.enigmaAnswers) {
              for (const spiritId in groupData.data.enigmaAnswers) {
                  const answer = groupData.data.enigmaAnswers[spiritId];
                  if (answer) {
                      updateUIAfterEncounter(spiritId, answer);
                  }
              }
          }
      }

      // --- Event Handlers ---
      function handleSpiritForm(event, spiritId) {
        event.preventDefault();
        const input = document.getElementById(`code${spiritId}`);
        spiritErrorP.textContent = '';
        if (input.value.toLowerCase().trim() === spiritCodes[spiritId]) {
          window.location.href = `Esprit.html?id=${spiritId}&group=${encodeURIComponent(groupName)}`;
        } else {
          spiritErrorP.textContent = 'Code incorrect pour l\'Esprit ' + spiritId + '.';
          input.focus();
        }
      }

      async function handleLogin() {
          const passwordInput = document.getElementById('password');
          const groups = await getGroupsData();
          if (!groups) return;

          const groupData = groups[groupName];
          if (groupData && passwordInput.value === groupData.password) {
              sessionStorage.setItem(`auth_token_${groupName}`, 'true');
              showContent();
          } else {
              errorP.textContent = 'Mot de passe incorrect.';
          }
      }

      // --- Initialization ---
      if (params.get('from') === 'scores') {
        sessionStorage.setItem(`auth_token_${groupName}`, 'true');
      }

      // Listen for updates from other tabs/pages
      const updateChannel = new BroadcastChannel('scores_update');
      updateChannel.onmessage = (event) => {
        if (event.data === 'refresh') {
          console.log('Refresh message received, updating UI in 10 seconds.');
          setTimeout(() => {
            console.log('Updating UI now after 10-second delay.');
            checkEnigmas(); // Refresh the data and UI
          }, 10000);
        }
      };

      if (sessionStorage.getItem(`auth_token_${groupName}`) === 'true') {
        showContent();
      } else {
        loginContainer.classList.remove('hidden');
        document.getElementById('submitPassword').addEventListener('click', handleLogin);
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleLogin();
        });
      }

      // Attach form listeners
      document.getElementById('formA').addEventListener('submit', (e) => handleSpiritForm(e, 'A'));
      document.getElementById('formB').addEventListener('submit', (e) => handleSpiritForm(e, 'B'));
      document.getElementById('formC').addEventListener('submit', (e) => handleSpiritForm(e, 'C'));
      document.getElementById('formD').addEventListener('submit', (e) => handleSpiritForm(e, 'D'));
    });
  </script>
</body>
</html>
