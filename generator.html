<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Population</title>
    <style>
        :root {
            --primary-color: #5a88ca;
            --primary-hover: #3d6fa1;
            --secondary-color: #f4f4f4;
            --border-color: #ddd;
            --text-dark: #333;
            --text-light: #666;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--secondary-color);
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
            line-height: 1.6;
        }
        .page-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .page-header h1 {
            color: var(--primary-color);
            margin: 0;
        }
        .page-header h1 span {
            color: #e85d04;
        }
        .container {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }
        #configuration, #resultat {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #configuration {
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        h2, h3, h4 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        h4 {
            font-size: 1.1em;
            border-bottom: none;
            margin: 15px 0 10px;
        }
        .config-section {
            margin-bottom: 25px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input[type="number"], select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            box-sizing: border-box;
        }
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .buildings-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        .building-control-group {
            display: grid;
            grid-template-columns: 1fr 80px;
            align-items: center;
            gap: 8px;
        }
        .building-control-group label {
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
        }
        .building-control-group input {
            width: 80px;
            text-align: center;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 1em;
            font-weight: 500;
            flex-grow: 1;
        }
        button:hover {
            background: var(--primary-hover);
        }
        button.secondary {
            background-color: #6c757d;
        }
        button.secondary:hover {
            background-color: #5a6268;
        }
        #resultat h2 {
            margin-top: 0;
        }
        #resultat ul {
            padding-left: 20px;
            -webkit-column-count: 2;
            -moz-column-count: 2;
            column-count: 2;
        }
    </style>
</head>
<body>
    <div class="page-header">
        <h1>Générateur de Population pour <span id="city-name-title">...</span></h1>
    </div>
    <div class="container">
        <div id="configuration">
            <h2>Configuration de la Ville</h2>
            <div class="config-section">
                <h3>Paramètres de Base</h3>
                <div class="control-group">
                    <label for="g0-families">Nombre de familles fondatrices (calculé)</label>
                    <input type="number" id="g0-families" value="0" readonly>
                </div>
            </div>
            <div class="config-section">
                <h3>Bâtiments Importants</h3>
                <div id="buildings-list" class="buildings-list">
                </div>
            </div>
            <div class="config-section">
                <h3>Influence et Statut</h3>
                <div class="control-group">
                    <label for="market-influence">Influence du Marché</label>
                    <select id="market-influence" disabled>
                        <option value="local">Local (faible)</option>
                        <option value="grand">Grand (moyenne)</option>
                        <option value="regional">Régional (forte)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="city-age">Ancienneté</label>
                    <select id="city-age">
                        <option value="recente">Récente (moins de 50 ans)</option>
                        <option value="etablie">Établie (50-200 ans)</option>
                        <option value="ancienne">Ancienne (200-500 ans)</option>
                        <option value="antique">Antique (plus de 500 ans)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="city-status">Statut Actuel</label>
                    <select id="city-status">
                        <option value="prospere">Prospère</option>
                        <option value="stable">Stable</option>
                        <option value="difficulte">En difficulté</option>
                        <option value="declin">En déclin</option>
                    </select>
                </div>
            </div>
            <div class="button-group">
                <button id="save-config-btn" class="secondary">Sauvegarder la Config</button>
                <button id="generate-population-btn">Générer Métiers & Population</button>
            </div>
            <div class="button-group">
                <a href="map.html" style="text-decoration:none; color:white; flex-grow:1; text-align:center;" class="secondary"><button class="secondary" style="width:100%;">Retour à la carte</button></a>
            </div>
        </div>
        <div id="resultat">
             <h2>Résultat de la Génération</h2>
             <p>Cliquez sur "Générer Métiers & Population" après avoir choisi votre configuration.</p>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const cityNameTitle = document.getElementById('city-name-title');
        const g0FamiliesInput = document.getElementById('g0-families');
        const buildingsListDiv = document.getElementById('buildings-list');
        const marketInfluenceSelect = document.getElementById('market-influence');
        const cityAgeSelect = document.getElementById('city-age');
        const cityStatusSelect = document.getElementById('city-status');
        const saveConfigBtn = document.getElementById('save-config-btn');
        const generateBtn = document.getElementById('generate-population-btn');
        const resultatDiv = document.getElementById('resultat');

        const cityId = localStorage.getItem('currentCityId');
        const cityName = localStorage.getItem('currentCityName');
        const cityType = localStorage.getItem('currentCityType');
        let allRegions = {};

        const buildingData = {
            "Taverne / Auberge": { types: ['Hameau', 'Village', 'Ville', 'Capitale'], numeric: true },
            "Forge": { types: ['Hameau', 'Village', 'Ville', 'Capitale'], numeric: true },
            "Temple / Église": { types: ['Village', 'Ville', 'Capitale'], numeric: true },
            "Marché central": { types: ['Village', 'Ville', 'Capitale'], id: 'building-marchecentral', numeric: false },
            "Écuries": { types: ['Village', 'Ville', 'Capitale'], numeric: false },
            "Boulangerie": { types: ['Village', 'Ville', 'Capitale'], numeric: false },
            "Menuisier / Charpentier": { types: ['Village', 'Ville', 'Capitale'], numeric: false },
            "Tanneur / Maroquinier": { types: ['Village', 'Ville', 'Capitale'], numeric: false },
            "Herboristerie": { types: ['Hameau', 'Village', 'Ville'], numeric: false },
            "Brasserie / Distillerie": { types: ['Ville', 'Capitale'], numeric: false },
            "Tisserand / Tailleur": { types: ['Village', 'Ville', 'Capitale'], numeric: false },
            "Caserne / Garde": { types: ['Ville', 'Capitale'], numeric: false },
            "Murailles": { types: ['Ville', 'Capitale'], numeric: false },
            "Château / Manoir": { types: ['Ville', 'Capitale'], numeric: false },
            "Bibliothèque / Scriptorium": { types: ['Ville', 'Capitale'], numeric: false },
            "Échoppe d'alchimiste": { types: ['Ville', 'Capitale'], numeric: false },
            "Atelier de mage": { types: ['Ville', 'Capitale'], numeric: false },
            "Observatoire": { types: ['Capitale'], numeric: false },
            "Arène / Colisée": { types: ['Capitale'], numeric: false },
        };
        
        const jobData = {
            base_jobs: { /* ... */ },
            building_jobs: { /* ... */ },
            autonomous_jobs: [ /* ... */ ]
        };

        function populateBuildings() {
            buildingsListDiv.innerHTML = '';
            Object.entries(buildingData).forEach(([buildingName, data]) => {
                if (data.types.includes(cityType)) {
                    const id = data.id || `building-${buildingName.toLowerCase().replace(/[^a-z]/g, '')}`;
                    const group = document.createElement('div');
                    
                    if (data.numeric) {
                        group.className = 'building-control-group';
                        group.innerHTML = `<label for="${id}">${buildingName}</label>
                                           <input type="number" id="${id}" data-building-name="${buildingName}" value="0" min="0">`;
                    } else {
                        group.className = 'checkbox-group';
                        group.innerHTML = `<input type="checkbox" id="${id}" data-building-name="${buildingName}"><label for="${id}">${buildingName}</label>`;
                    }
                    
                    buildingsListDiv.appendChild(group);
                    group.querySelector('input').addEventListener('input', updateFamilyCount);
                }
            });
            const marketCheckbox = document.getElementById('building-marchecentral');
            if (marketCheckbox) {
                marketCheckbox.addEventListener('change', () => {
                    marketInfluenceSelect.disabled = !marketCheckbox.checked;
                });
            }
        }

        function updateFamilyCount() {
            let buildingCount = 0;
            document.querySelectorAll('#buildings-list input').forEach(input => {
                if (input.type === 'checkbox' && input.checked) {
                    buildingCount++;
                } else if (input.type === 'number') {
                    buildingCount += parseInt(input.value) || 0;
                }
            });
            const familyCount = buildingCount * 6;
            g0FamiliesInput.value = familyCount;
        }

        function loadData() {
            const savedData = localStorage.getItem('allRegionsData');
            if (!savedData) { window.location.href = 'map.html'; return; }
            allRegions = JSON.parse(savedData);
            const regionName = Object.keys(allRegions.regions).find(rName => allRegions.regions[rName].cities.some(c => c.id === cityId));
            if (!regionName) { window.location.href = 'map.html'; return; }
            const cityData = allRegions.regions[regionName].cities.find(c => c.id === cityId);

            if (cityData && cityData.config) {
                marketInfluenceSelect.value = cityData.config.market_influence || 'local';
                cityAgeSelect.value = cityData.config.city_age || 'recente';
                cityStatusSelect.value = cityData.config.city_status || 'stable';

                Object.entries(cityData.config.buildings || {}).forEach(([buildingName, value]) => {
                   const input = document.querySelector(`input[data-building-name="${buildingName}"]`);
                   if (input) {
                       if (input.type === 'checkbox') {
                           input.checked = value;
                       } else if (input.type === 'number') {
                           input.value = value;
                       }
                   }
                });
                if(cityData.config.generatedJobsHtml) {
                    resultatDiv.innerHTML = cityData.config.generatedJobsHtml;
                }
            }
            if (cityName) { cityNameTitle.textContent = cityName; } 
            else { window.location.href = 'map.html'; }
            updateFamilyCount();
            const marketCheckbox = document.getElementById('building-marchecentral');
            if (marketCheckbox) { marketInfluenceSelect.disabled = !marketCheckbox.checked; }
        }

        function saveConfig() {
            const regionName = Object.keys(allRegions.regions).find(rName => allRegions.regions[rName].cities.some(c => c.id === cityId));
            if (!regionName) return;
            const cityData = allRegions.regions[regionName].cities.find(c => c.id === cityId);
            if (!cityData) return;
            if (!cityData.config) cityData.config = {};
            
            const buildingsConfig = {};
            document.querySelectorAll('#buildings-list input').forEach(input => {
                const name = input.dataset.buildingName;
                if (input.type === 'checkbox') {
                    buildingsConfig[name] = input.checked;
                } else if (input.type === 'number') {
                    buildingsConfig[name] = parseInt(input.value) || 0;
                }
            });

            cityData.config.g0_families = parseInt(g0FamiliesInput.value);
            cityData.config.buildings = buildingsConfig;
            cityData.config.market_influence = marketInfluenceSelect.value;
            cityData.config.city_age = cityAgeSelect.value;
            cityData.config.city_status = cityStatusSelect.value;
            saveAllRegions();
        }
        
        function generatePopulation() { /* ... unchanged ... */ }
        function saveAllRegions() {
             localStorage.setItem('allRegionsData', JSON.stringify(allRegions));
        }
        function markCityAsEdited() { /* ... unchanged ... */ }

        saveConfigBtn.addEventListener('click', saveConfig);
        generateBtn.addEventListener('click', generatePopulation);

        populateBuildings();
        loadData();
    });
    </script>
</body>
</html>