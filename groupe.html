<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Page du Groupe</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; text-align: center; padding-top: 50px; }
    #login, #content { max-width: 400px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    #content { display: none; }
    input { width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; }
    button { padding: 10px 20px; cursor: pointer; }
    .enigma-alert {
        margin-left: 10px;
        color: #ffc107;
        font-weight: bold;
        animation: blink-animation 1s infinite;
    }
    @keyframes blink-animation {
        0% { opacity: 1; }
        50% { opacity: 0; }
        100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="login">
    <h1 id="groupName"></h1>
    <input type="password" id="password" placeholder="Mot de passe">
    <button id="submitPassword">Entrer</button>
    <p id="error" style="color:red;"></p>
  </div>

  <div id="content">
    <h2>Bienvenue, <span id="welcomeGroupName"></span>!</h2>
    <p>Sauvez le compte, rencontrer les esprits (mettez du son, les esprits vous parleront) :</p>
    <p style="color: #ffc107; font-weight: bold;">!! Attention, chaque relecture audio vous déduira des points dans le tableau des scores !!</p>

    <div id="spirits-container">
      <form class="spirit-form" id="formA">
        <label for="codeA">- Esprit A</label>
        <input type="text" id="codeA" placeholder="entrer le code">
        <button type="submit">Rencontrer</button>
        <span id="enigmaA" class="enigma-alert" style="display: none;">!! Enigme Esprit A a enregistrer !!</span>
      </form>
      <form class="spirit-form" id="formB">
        <label for="codeB">- Esprit B</label>
        <input type="text" id="codeB" placeholder="entrer le code">
        <button type="submit">Rencontrer</button>
        <span id="enigmaB" class="enigma-alert" style="display: none;">!! Enigme Esprit B a enregistrer !!</span>
      </form>
      <form class="spirit-form" id="formC">
        <label for="codeC">- Esprit C</label>
        <input type="text" id="codeC" placeholder="entrer le code">
        <button type="submit">Rencontrer</button>
        <span id="enigmaC" class="enigma-alert" style="display: none;">!! Enigme Esprit C a enregistrer !!</span>
      </form>
      <form class="spirit-form" id="formD">
        <label for="codeD">- Esprit D</label>
        <input type="text" id="codeD" placeholder="entrer le code">
        <button type="submit">Rencontrer</button>
        <span id="enigmaD" class="enigma-alert" style="display: none;">!! Enigme Esprit D a enregistrer !!</span>
      </form>
    </div>
    <p id="spiritError" style="color:red;"></p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const groupName = params.get('name');
      const groupNameH1 = document.getElementById('groupName');
      const welcomeGroupNameSpan = document.getElementById('welcomeGroupName');

      if (!groupName) {
        document.body.innerHTML = '<h1>Aucun groupe spécifié.</h1>';
        return;
      }

      groupNameH1.textContent = `Groupe: ${groupName}`;
      welcomeGroupNameSpan.textContent = groupName;

      async function getGroupsData() {
        const apiUrl = 'https://api.github.com/repos/Zhaal/un-loup-garou-a-eu/contents/scores-loup-garou.json';
        const response = await fetch(`${apiUrl}?ref=main`, {
          headers: { 'Accept': 'application/vnd.github.v3.raw' },
          cache: 'no-store'
        });
        if (!response.ok) throw new Error('Could not fetch group data from GitHub.');
        return await response.json();
      }

      async function checkEnigmas() {
        try {
          const allGroups = await getGroupsData();
          const groupData = allGroups[groupName];

          if (groupData && groupData.data && groupData.data.enigmaAnswers) {
            for (const spiritId in groupData.data.enigmaAnswers) {
              const answer = groupData.data.enigmaAnswers[spiritId];
              if (answer) {
                const form = document.getElementById(`form${spiritId}`);
                const input = document.getElementById(`code${spiritId}`);
                const button = form.querySelector('button');
                const enigmaAlert = document.getElementById(`enigma${spiritId}`);

                input.value = answer;
                button.disabled = true;
                if (enigmaAlert) {
                  enigmaAlert.style.display = 'none';
                }
              }
            }
          }
        } catch (err) {
          console.error("Erreur lors de la vérification des énigmes:", err);
        }
      }

      const spiritCodes = {
        A: 'a17b',
        B: 'c22t',
        C: 'u65p',
        D: 's12v'
      };

      function showContent() {
        document.getElementById('login').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        checkEnigmas();
      }

      if (sessionStorage.getItem(`auth_token_${groupName}`) === 'true') {
        showContent();
      } else {
        const passwordInput = document.getElementById('password');
        const submitButton = document.getElementById('submitPassword');
        const errorP = document.getElementById('error');

        submitButton.addEventListener('click', async () => {
          try {
            const groups = await getGroupsData();
            const groupData = groups[groupName];

            if (groupData && passwordInput.value === groupData.password) {
              sessionStorage.setItem(`auth_token_${groupName}`, 'true');
              showContent();
            } else {
              errorP.textContent = 'Mot de passe incorrect.';
            }
          } catch (err) {
            errorP.textContent = `Erreur: ${err.message}`;
          }
        });
      }

      document.getElementById('formA').addEventListener('submit', (e) => handleSpiritForm(e, 'A'));
      document.getElementById('formB').addEventListener('submit', (e) => handleSpiritForm(e, 'B'));
      document.getElementById('formC').addEventListener('submit', (e) => handleSpiritForm(e, 'C'));
      document.getElementById('formD').addEventListener('submit', (e) => handleSpiritForm(e, 'D'));

      function handleSpiritForm(event, spiritId) {
        event.preventDefault();
        const input = document.getElementById(`code${spiritId}`);
        const errorEl = document.getElementById('spiritError');
        if (input.value.toLowerCase().trim() === spiritCodes[spiritId]) {
          window.location.href = `Esprit.html?id=${spiritId}&group=${encodeURIComponent(groupName)}`;
        } else {
          errorEl.textContent = 'Code incorrect.';
          input.focus();
        }
      }
    });
  </script>
</body>
</html>