<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Page du Groupe</title>
  <link rel="stylesheet" href="style.css">

  <!-- PWA Meta tags -->
  <meta name="theme-color" content="#1f8a70">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Loup-Garou">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    #content.hidden, #login.hidden {
      display: none;
    }
    .warning-text {
        color: #e43f5a;
        font-weight: bold;
        background-color: rgba(228, 63, 90, 0.1);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e43f5a;
    }
    #spirits-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
    }
    .spirit-card {
        flex-basis: 250px; /* Set a base width for flex items */
    }
    .spirit-card {
      background-color: #1a1a2e;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #1f4068;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .spirit-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0 15px rgba(228, 63, 90, 0.5);
    }
    .spirit-card h3 {
        margin-top: 0;
        color: #1f8a70;
    }
    .spirit-form {
        margin-top: 15px;
    }
    .enigma-alert {
        margin-top: 10px;
        color: #e43f5a;
        font-weight: bold;
        animation: blink-animation 1.5s infinite;
    }
    @keyframes blink-animation {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    #map-container {
        margin: 30px 0;
        background-color: #1a1a2e;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #1f4068;
    }
    #map {
        width: 100%;
        height: 500px;
        border-radius: 8px;
        margin-bottom: 15px;
    }
    #navigation-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }
    .nav-button {
        background-color: #1f8a70;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }
    .nav-button:hover {
        background-color: #166d5a;
        transform: scale(1.05);
    }
    .nav-button:disabled {
        background-color: #555;
        cursor: not-allowed;
        transform: scale(1);
    }
    #location-status {
        margin-top: 10px;
        padding: 10px;
        background-color: rgba(31, 138, 112, 0.1);
        border-radius: 5px;
        text-align: center;
    }
  </style>
  <script src="network.js"></script>
</head>
<body>
  <div id="login" class="container">
    <h1 id="groupName"></h1>
    <p>Veuillez entrer le mot de passe pour continuer.</p>
    <form id="login-form">
      <input type="password" id="password" placeholder="Mot de passe du groupe">
      <button id="submitPassword" type="button">Entrer</button>
    </form>
    <p id="error" class="error-message"></p>
  </div>

  <div id="content" class="container hidden">
    <h2>Bienvenue, <span id="welcomeGroupName"></span>!</h2>
    <p>Les esprits attendent. Entrez leurs codes pour les rencontrer. Mettez du son, ils vous parleront.</p>
    <p class="warning-text">Attention, chaque relecture audio vous coûtera des points!</p>

    <!-- Google Maps Navigation Section -->
    <div id="map-container">
      <h3>Carte de Navigation</h3>
      <div id="map"></div>
      <div id="navigation-controls">
        <button class="nav-button" onclick="navigateToPoint('espritA')">Aller à l'Esprit A</button>
        <button class="nav-button" onclick="navigateToPoint('espritB')">Aller à l'Esprit B</button>
        <button class="nav-button" onclick="navigateToPoint('espritC')">Aller à l'Esprit C</button>
        <button class="nav-button" onclick="navigateToPoint('espritD')">Aller à l'Esprit D</button>
        <button class="nav-button" onclick="navigateToPoint('local')">Retour au Local</button>
      </div>
      <div id="location-status">Cliquez sur un bouton pour obtenir les directions</div>
    </div>

    <div id="spirits-container">
      <!-- Spirit cards will be dynamically generated or can be hardcoded -->
      <div class="spirit-card" id="cardA">
        <h3>Esprit A</h3>
        <form class="spirit-form" id="formA">
          <input type="text" id="codeA" placeholder="Code de l'esprit">
          <button type="submit">Rencontrer</button>
          <span id="enigmaA" class="enigma-alert hidden">Énigme reçue !</span>
        </form>
      </div>
      <div class="spirit-card" id="cardB">
        <h3>Esprit B</h3>
        <form class="spirit-form" id="formB">
          <input type="text" id="codeB" placeholder="Code de l'esprit">
          <button type="submit">Rencontrer</button>
          <span id="enigmaB" class="enigma-alert hidden">Énigme reçue !</span>
        </form>
      </div>
      <div class="spirit-card" id="cardC">
        <h3>Esprit C</h3>
        <form class="spirit-form" id="formC">
          <input type="text" id="codeC" placeholder="Code de l'esprit">
          <button type="submit">Rencontrer</button>
          <span id="enigmaC" class="enigma-alert hidden">Énigme reçue !</span>
        </form>
      </div>
      <div class="spirit-card" id="cardD">
        <h3>Esprit D</h3>
        <form class="spirit-form" id="formD">
          <input type="text" id="codeD" placeholder="Code de l'esprit">
          <button type="submit">Rencontrer</button>
          <span id="enigmaD" class="enigma-alert hidden">Énigme reçue !</span>
        </form>
      </div>
    </div>
    <p id="spiritError" class="error-message"></p>
    <a href="joueur.html" style="margin-top: 30px; display: inline-block;">Changer de groupe</a>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const params = new URLSearchParams(window.location.search);
      const groupName = params.get('name');

      if (!groupName) {
        document.body.innerHTML = '<div class="container"><h1>Aucun groupe spécifié.</h1><a href="joueur.html">Retour</a></div>';
        return;
      }

      // Setup page elements
      document.getElementById('groupName').textContent = `Groupe: ${groupName}`;
      document.getElementById('welcomeGroupName').textContent = groupName;
      const loginContainer = document.getElementById('login');
      const contentContainer = document.getElementById('content');
      const errorP = document.getElementById('error');
      const spiritErrorP = document.getElementById('spiritError');

      // --- Data Fetching ---
      async function getGroupsData() {
        try {
            return await networkManager.getGroupsData();
        } catch (err) {
            errorP.textContent = `Erreur critique: ${err.message}`;
            return null;
        }
      }

      // --- UI Update Functions ---
      function updateUIAfterEncounter(spiritId, answer) {
        const input = document.getElementById(`code${spiritId}`);
        const button = document.getElementById(`form${spiritId}`).querySelector('button');
        const card = document.getElementById(`card${spiritId}`);

        input.value = `Rencontré (${answer})`;
        input.disabled = true;
        button.disabled = true;
        button.textContent = 'Terminé';
        card.style.borderColor = '#1f8a70'; // Teal border for completed
      }

      const spiritCodes = { A: '117b', B: '222t', C: '365p', D: '412v' };

      function showContent() {
        loginContainer.classList.add('hidden');
        contentContainer.classList.remove('hidden');
        checkEnigmas();
      }

      async function checkEnigmas() {
          const allGroups = await getGroupsData();
          if (!allGroups) return;
          const groupData = allGroups[groupName];

          if (groupData?.data?.enigmaAnswers) {
              for (const spiritId in groupData.data.enigmaAnswers) {
                  const answer = groupData.data.enigmaAnswers[spiritId];
                  if (answer) {
                      updateUIAfterEncounter(spiritId, answer);
                  }
              }
          }
      }

      // --- Event Handlers ---
      function handleSpiritForm(event, spiritId) {
        event.preventDefault();
        const input = document.getElementById(`code${spiritId}`);
        spiritErrorP.textContent = '';
        if (input.value.toLowerCase().trim() === spiritCodes[spiritId]) {
          window.location.href = `Esprit.html?id=${spiritId}&group=${encodeURIComponent(groupName)}`;
        } else {
          spiritErrorP.textContent = 'Code incorrect pour l\'Esprit ' + spiritId + '.';
          input.focus();
        }
      }

      async function handleLogin() {
          const passwordInput = document.getElementById('password');
          const groups = await getGroupsData();
          if (!groups) return;

          const groupData = groups[groupName];
          if (groupData && passwordInput.value === groupData.password) {
              sessionStorage.setItem(`auth_token_${groupName}`, 'true');
              showContent();
          } else {
              errorP.textContent = 'Mot de passe incorrect.';
          }
      }

      // --- Initialization ---
      if (params.get('from') === 'scores') {
        sessionStorage.setItem(`auth_token_${groupName}`, 'true');
      }

      // Configurer le callback de rafraîchissement automatique
      networkManager.onRefresh(() => {
        console.log('Refresh message received, updating UI...');
        checkEnigmas(); // Refresh the data and UI
      });

      if (sessionStorage.getItem(`auth_token_${groupName}`) === 'true') {
        showContent();
      } else {
        loginContainer.classList.remove('hidden');
        document.getElementById('submitPassword').addEventListener('click', handleLogin);
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleLogin();
        });
      }

      // Attach form listeners
      document.getElementById('formA').addEventListener('submit', (e) => handleSpiritForm(e, 'A'));
      document.getElementById('formB').addEventListener('submit', (e) => handleSpiritForm(e, 'B'));
      document.getElementById('formC').addEventListener('submit', (e) => handleSpiritForm(e, 'C'));
      document.getElementById('formD').addEventListener('submit', (e) => handleSpiritForm(e, 'D'));
    });
  </script>

  <!-- Leaflet.js pour les cartes (100% gratuit, sans clé API) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
    // Points d'intérêt avec leurs coordonnées
    const pointsOfInterest = {
      espritA: { lat: 50.049915164743055, lng: 1.418272345174004, name: "Esprit A", color: "red" },
      espritB: { lat: 50.04999601139354, lng: 1.4143768286465412, name: "Esprit B", color: "red" },
      espritC: { lat: 50.048870431476594, lng: 1.4180009496088808, name: "Esprit C", color: "red" },
      espritD: { lat: 50.049277302076064, lng: 1.4198630265038947, name: "Esprit D", color: "red" },
      local: { lat: 50.049722268440206, lng: 1.4188271764072187, name: "Local de Départ", color: "green" }
    };

    let map;
    let markers = {};
    let userMarker = null;
    let userPosition = null;

    // Initialiser la carte Leaflet
    function initMap() {
      // Centre de la carte (Local de départ)
      const centerPosition = [50.049722268440206, 1.4188271764072187];

      // Créer la carte avec OpenStreetMap
      map = L.map('map').setView(centerPosition, 16);

      // Ajouter les tuiles OpenStreetMap (gratuit, pas de clé API)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      // Créer des icônes personnalisées
      const redIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      const greenIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      const blueIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      // Ajouter des marqueurs pour chaque point d'intérêt
      Object.keys(pointsOfInterest).forEach(key => {
        const point = pointsOfInterest[key];
        const icon = point.color === 'green' ? greenIcon : redIcon;

        const marker = L.marker([point.lat, point.lng], { icon: icon })
          .addTo(map)
          .bindPopup(`<b>${point.name}</b><br>Cliquez sur le bouton pour naviguer`);

        markers[key] = marker;
      });

      // Essayer d'obtenir la position de l'utilisateur
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (position) => {
            userPosition = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            // Ajouter ou mettre à jour le marqueur de l'utilisateur
            if (userMarker) {
              userMarker.setLatLng([userPosition.lat, userPosition.lng]);
            } else {
              userMarker = L.marker([userPosition.lat, userPosition.lng], { icon: blueIcon })
                .addTo(map)
                .bindPopup('<b>Votre position</b>');
            }

            document.getElementById('location-status').textContent = 'Position détectée ! Cliquez sur un bouton pour naviguer.';
          },
          () => {
            document.getElementById('location-status').textContent = 'Localisation désactivée. Activez-la pour une meilleure navigation.';
          },
          {
            enableHighAccuracy: true,
            maximumAge: 10000,
            timeout: 5000
          }
        );
      }
    }

    // Fonction pour naviguer vers un point
    function navigateToPoint(pointKey) {
      const destination = pointsOfInterest[pointKey];

      if (!destination) {
        alert('Point d\'intérêt non trouvé!');
        return;
      }

      // Construire l'URL Google Maps avec directions (Google Maps reste le meilleur pour la navigation en temps réel)
      let mapsUrl;

      if (userPosition) {
        // Si on a la position de l'utilisateur, créer un itinéraire
        mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userPosition.lat},${userPosition.lng}&destination=${destination.lat},${destination.lng}&travelmode=walking`;
      } else {
        // Sinon, juste afficher le point sur la carte
        mapsUrl = `https://www.google.com/maps/search/?api=1&query=${destination.lat},${destination.lng}`;
      }

      // Ouvrir Google Maps dans un nouvel onglet
      window.open(mapsUrl, '_blank');

      // Mettre à jour le statut
      document.getElementById('location-status').innerHTML = `Navigation vers <strong>${destination.name}</strong> ouverte dans Google Maps!`;

      // Centrer la carte sur le point sélectionné et ouvrir le popup
      map.setView([destination.lat, destination.lng], 18);
      markers[pointKey].openPopup();
    }

    // Initialiser la carte quand la page est chargée
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initMap, 100);
      });
    } else {
      setTimeout(initMap, 100);
    }

    // Enregistrer le Service Worker pour PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('Service Worker enregistré avec succès:', registration.scope);
          })
          .catch((error) => {
            console.log('Échec de l\'enregistrement du Service Worker:', error);
          });
      });
    }
  </script>
</body>
</html>
